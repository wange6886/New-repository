<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Insight Tool - DeepSeek Edition</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- 图标组件定义 (替代 lucide-react 以适应单文件 HTML) ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const Icons = {
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>,
            Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>,
            Loader2: <><path d="M21 12a9 9 0 1 1-6.219-8.56"/></>, // Spinner part
            AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
            File: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>,
            Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
            Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
            X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            Key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></>,
            Copy: <><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>,
            ChevronRight: <><polyline points="9 18 15 12 9 6"/></>
        };

        const LucideIcon = ({ name, ...props }) => {
            return <Icon path={Icons[name] || Icons.FileText} {...props} />;
        };

        // --- 全局配置 ---
        const DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions";
        // 设置 PDF.js Worker 路径
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- 工具函数 ---
        const formatContext = (parsedData) => {
            if (!parsedData || parsedData.length === 0) return "";
            const fullText = parsedData.map(page => 
                `Page ${page.page}:\n` + 
                page.paragraphs.map(p => `[${p.id}] ${p.text}`).join('\n')
            ).join('\n\n');
            return fullText.slice(0, 30000); 
        };

        // --- API 服务层 ---
        const extractTextFromPdf = async (file) => {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const parsedData = [];
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const rawStrings = textContent.items.map(item => item.str).filter(s => s.trim().length > 0);
                    
                    let currentParaText = "";
                    let paraIndex = 1;
                    const paragraphs = [];

                    rawStrings.forEach((str, idx) => {
                        currentParaText += str + " ";
                        if (currentParaText.length > 150 || str.match(/[。！？\.\!\?]$/) || idx === rawStrings.length - 1) {
                            paragraphs.push({
                                id: `P${i}-${paraIndex}`,
                                text: currentParaText.trim()
                            });
                            currentParaText = "";
                            paraIndex++;
                        }
                    });

                    if (paragraphs.length > 0) {
                        parsedData.push({ page: i, paragraphs });
                    }
                }
                return parsedData;
            } catch (error) {
                console.error("PDF Parse Error:", error);
                throw new Error("PDF 解析失败，请确保文件未加密");
            }
        };

        const apiService = {
            upload: (file, onProgress) => {
                return new Promise((resolve) => {
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 10; 
                        onProgress(progress);
                        if (progress >= 100) {
                            clearInterval(interval);
                            resolve({ status: 'success' });
                        }
                    }, 50);
                });
            },
            
            parse: async (file) => {
                const data = await extractTextFromPdf(file);
                return { code: 0, data };
            },

            askAI: async (question, contextData, apiKey) => {
                if (!apiKey) {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            resolve({
                                answer: `（演示模式）\n我已读取文档共 ${contextData.length} 页。\n\n由于未配置 API Key，无法调用 DeepSeek。\n\n检测到文档开头：\n"${contextData[0]?.paragraphs[0]?.text?.slice(0, 50)}..."\n\n请点击右上角【配置 API】填入 Key 以解锁全部功能。`,
                                sources: []
                            });
                        }, 800);
                    });
                }

                try {
                    const systemPrompt = `你是一个智能 PDF 助手。请基于以下文档内容回答用户问题。
                    引用要求：尽量在句末标注来源 ID，格式为 [来源: Px-x]。
                    文档内容：\n${formatContext(contextData)}`;

                    const response = await fetch(DEEPSEEK_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: systemPrompt },
                                { role: "user", content: question }
                            ],
                            temperature: 0.3
                        })
                    });

                    if (!response.ok) throw new Error('API 请求失败');
                    const data = await response.json();
                    return { answer: data.choices[0].message.content, sources: [] };
                } catch (error) {
                    throw new Error(`DeepSeek 调用失败: ${error.message}`);
                }
            },

            summarize: async (contextData, apiKey) => {
                if (!apiKey) {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            resolve({ summary: `（演示模式）\n请配置 DeepSeek API Key 以生成真实总结。\n当前文档包含 ${contextData.reduce((acc, p) => acc + p.paragraphs.length, 0)} 个段落。` });
                        }, 1000);
                    });
                }

                try {
                    const systemPrompt = `请基于以下文档生成结构化摘要（核心观点、关键数据、重要结论），使用 Markdown 格式。\n文档内容：\n${formatContext(contextData)}`;
                    
                    const response = await fetch(DEEPSEEK_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: systemPrompt },
                                { role: "user", content: "请总结这篇文档。" }
                            ],
                            temperature: 0.5
                        })
                    });

                    if (!response.ok) throw new Error('API 请求失败');
                    const data = await response.json();
                    return { summary: data.choices[0].message.content };
                } catch (error) {
                    throw new Error(`总结失败: ${error.message}`);
                }
            }
        };

        // --- 组件定义 ---

        const SettingsModal = ({ isOpen, onClose, apiKey, onSave }) => {
            const [tempKey, setTempKey] = useState(apiKey || '');
            useEffect(() => { if (isOpen) setTempKey(apiKey || ''); }, [isOpen, apiKey]);
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md animate-in fade-in zoom-in duration-200">
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <h3 className="font-semibold text-gray-800 flex items-center gap-2">
                                <LucideIcon name="Settings" size={18} /> API 设置
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><LucideIcon name="X" size={20} /></button>
                        </div>
                        <div className="p-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">DeepSeek API Key</label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><LucideIcon name="Key" size={16} /></div>
                                <input type="password" value={tempKey} onChange={(e) => setTempKey(e.target.value)} placeholder="sk-..." className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                            </div>
                            <p className="text-xs text-gray-500 mt-2">Key 仅存储在本地浏览器，不做上传。</p>
                        </div>
                        <div className="px-6 py-4 bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded-lg">取消</button>
                            <button onClick={() => { onSave(tempKey); onClose(); }} className="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg">保存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Header = ({ onOpenSettings, hasKey }) => (
            <header className="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-10 shrink-0">
                <div className="flex items-center gap-2">
                    <div className="bg-blue-600 p-1.5 rounded-lg text-white"><LucideIcon name="FileText" size={20} /></div>
                    <h1 className="text-lg font-bold text-gray-800 tracking-wide">PDF Insight Tool <span className="text-xs font-normal text-gray-500 ml-2 bg-gray-100 px-2 py-0.5 rounded-full">DeepSeek V3</span></h1>
                </div>
                <button onClick={onOpenSettings} className={`p-2 rounded-lg flex items-center gap-2 text-sm font-medium ${hasKey ? 'text-blue-600 bg-blue-50' : 'text-gray-500 hover:bg-gray-100'}`}>
                    <LucideIcon name="Settings" size={18} /> {hasKey ? 'DeepSeek 已就绪' : '配置 API'}
                </button>
            </header>
        );

        const UploadZone = ({ onFileSelected, uploadProgress, status, errorMsg, reset, file }) => {
            const fileInputRef = useRef(null);
            const [dragActive, setDragActive] = useState(false);

            const handleDrop = (e) => {
                e.preventDefault(); e.stopPropagation(); setDragActive(false);
                if (e.dataTransfer.files?.[0]) validateAndUpload(e.dataTransfer.files[0]);
            };

            const validateAndUpload = (f) => {
                if (f.type !== 'application/pdf') return onFileSelected(null, '仅支持 PDF 文件');
                if (f.size > 50 * 1024 * 1024) return onFileSelected(null, '建议文件 ≤50MB');
                onFileSelected(f, null);
            };

            if (status === 'parsing' || status === 'interactive') {
                return (
                    <div className="flex flex-col h-full bg-slate-50 border-r border-gray-200 p-6 w-[300px] shrink-0">
                        <h3 className="font-semibold text-gray-700 mb-4 flex items-center gap-2"><LucideIcon name="File" size={18} /> 当前文件</h3>
                        <div className="bg-white p-4 rounded-xl border border-blue-100 shadow-sm mb-6">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="bg-red-50 text-red-500 p-2 rounded-lg"><LucideIcon name="FileText" size={24} /></div>
                                <div className="overflow-hidden">
                                    <p className="text-sm font-medium text-gray-800 truncate">{file?.name || 'document.pdf'}</p>
                                    <p className="text-xs text-gray-500">{file ? (file.size/1024/1024).toFixed(2) : '0'} MB</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-xs text-green-600 bg-green-50 px-2 py-1 rounded w-fit"><LucideIcon name="CheckCircle" size={12} /> 已解析</div>
                        </div>
                        <button onClick={reset} className="mt-auto w-full py-2.5 px-4 bg-white border rounded-lg hover:bg-gray-50 text-sm font-medium">重新上传</button>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full bg-slate-50 border-r border-gray-200 p-8 justify-center items-center text-center w-[300px] shrink-0">
                    <div 
                        className={`w-full border-2 border-dashed rounded-2xl p-8 flex flex-col items-center justify-center gap-4 transition-colors ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white'} ${errorMsg ? 'border-red-300 bg-red-50' : ''}`}
                        onDragEnter={(e)=>{e.preventDefault();e.stopPropagation();setDragActive(true)}}
                        onDragLeave={(e)=>{e.preventDefault();e.stopPropagation();setDragActive(false)}}
                        onDragOver={(e)=>{e.preventDefault();e.stopPropagation();setDragActive(true)}}
                        onDrop={handleDrop}
                    >
                        {status === 'uploading' ? (
                            <div className="w-full">
                                <div className="animate-spin text-blue-600 mx-auto mb-4"><LucideIcon name="Loader2" size={32} /></div>
                                <p className="text-sm font-medium mb-2">读取文件中...</p>
                                <div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-blue-600 h-2 rounded-full transition-all" style={{width: `${uploadProgress}%`}}></div></div>
                            </div>
                        ) : (
                            <>
                                <div className={`p-4 rounded-full ${errorMsg ? 'bg-red-100 text-red-500' : 'bg-blue-50 text-blue-600'}`}>
                                    <LucideIcon name={errorMsg ? "AlertCircle" : "Upload"} size={32} />
                                </div>
                                <div>
                                    <p className="font-semibold mb-1">点击或拖拽上传</p>
                                    <p className="text-xs text-gray-500">支持 PDF / 本地解析</p>
                                </div>
                                <input ref={fileInputRef} type="file" accept=".pdf" className="hidden" onChange={(e) => e.target.files?.[0] && validateAndUpload(e.target.files[0])} />
                                <button onClick={() => fileInputRef.current.click()} className="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">选择文件</button>
                                {errorMsg && <p className="text-xs text-red-500 bg-red-50 px-3 py-1 rounded-full">{errorMsg}</p>}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const PreviewZone = ({ parsedData, status, highlightedId }) => {
            const refs = useRef({});
            useEffect(() => {
                if (highlightedId && refs.current[highlightedId]) {
                    refs.current[highlightedId].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, [highlightedId]);

            if (status !== 'interactive') {
                return (
                    <div className="flex-1 bg-gray-100 flex items-center justify-center p-8">
                        {status === 'parsing' ? (
                            <div className="text-center">
                                <div className="animate-spin text-blue-600 mx-auto mb-4"><LucideIcon name="Loader2" size={40} /></div>
                                <p className="text-gray-600 font-medium">正在解析 PDF...</p>
                            </div>
                        ) : (
                            <div className="text-center text-gray-400">
                                <div className="mx-auto mb-4 opacity-30"><LucideIcon name="FileText" size={48} /></div>
                                <p>请上传文档以预览</p>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="flex-1 bg-gray-100 overflow-y-auto p-8 scroll-smooth">
                    <div className="max-w-3xl mx-auto bg-white shadow-lg min-h-full rounded-lg">
                        {parsedData.map((page) => (
                            <div key={page.page} className="border-b border-gray-100 last:border-0 relative">
                                <div className="sticky top-0 bg-gray-50/90 backdrop-blur-sm px-8 py-2 text-xs font-semibold text-gray-500 border-b z-10">Page {page.page}</div>
                                <div className="p-8 space-y-4">
                                    {page.paragraphs.map((para) => (
                                        <div key={para.id} ref={el => refs.current[para.id] = el} className={`relative pl-4 rounded-r-lg transition-colors ${highlightedId === para.id ? 'bg-yellow-50 ring-2 ring-yellow-200' : 'hover:bg-blue-50/30'}`}>
                                            <span className="absolute left-0 top-1 text-[10px] text-blue-300 font-mono select-none">{para.id}</span>
                                            <p className="text-gray-800 text-sm leading-relaxed text-justify">{para.text}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ChatZone = ({ status, onJumpTo, history, onSend, isAiThinking, summary, onGenerateSummary, isSummarizing, apiKey }) => {
            const [input, setInput] = useState('');
            const endRef = useRef(null);
            
            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [history, isAiThinking]);

            const renderContent = (content) => content.split(/(\[来源[:：] ?[A-Z0-9-]+\])/g).map((part, i) => {
                const match = part.match(/\[来源[:：] ?([A-Z0-9-]+)\]/);
                if (match) return <button key={i} onClick={() => onJumpTo(match[1])} className="text-xs text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded mx-1 hover:bg-blue-100">{match[1]}</button>;
                return part;
            });

            if (status !== 'interactive') return <div className="w-96 border-l bg-white flex items-center justify-center text-sm text-gray-500">等待文档解析...</div>;

            return (
                <div className="w-96 border-l bg-white flex flex-col h-full shadow-xl shrink-0 z-20">
                    <div className="p-4 border-b flex justify-between items-center bg-white">
                        <h2 className="font-semibold text-gray-800">AI 助手</h2>
                        {!summary ? (
                            <button onClick={onGenerateSummary} disabled={isSummarizing} className="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-3 py-1.5 rounded-lg flex items-center gap-1 disabled:opacity-50">
                                {isSummarizing ? <LucideIcon name="Loader2" size={12} className="animate-spin" /> : <LucideIcon name="FileText" size={12} />} 生成总结
                            </button>
                        ) : <span className="text-xs text-green-600 flex items-center gap-1"><LucideIcon name="CheckCircle" size={12} /> 已生成</span>}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-6 bg-gray-50/50">
                        <div className="flex gap-3">
                            <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0 text-white text-xs font-bold">AI</div>
                            <div className="bg-white border p-3 rounded-2xl rounded-tl-none text-sm text-gray-700 shadow-sm">{apiKey ? "DeepSeek 已连接！" : "演示模式（请配置 Key）"}</div>
                        </div>
                        {history.map((msg, i) => (
                            <div key={i} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-white text-xs font-bold ${msg.role === 'user' ? 'bg-gray-800' : 'bg-blue-600'}`}>{msg.role === 'user' ? 'U' : 'AI'}</div>
                                <div className={`p-3 rounded-2xl text-sm shadow-sm max-w-[85%] whitespace-pre-wrap ${msg.role === 'user' ? 'bg-gray-800 text-white rounded-tr-none' : 'bg-white border text-gray-700 rounded-tl-none'} ${msg.isError ? 'bg-red-50 text-red-600 border-red-200' : ''}`}>
                                    {renderContent(msg.content)}
                                </div>
                            </div>
                        ))}
                        {isAiThinking && <div className="flex gap-3"><div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0"><LucideIcon name="Loader2" size={14} className="text-white animate-spin" /></div><div className="bg-white border px-4 py-3 rounded-2xl rounded-tl-none shadow-sm text-gray-400 text-xs">AI 思考中...</div></div>}
                        {summary && <div className="mt-4 border border-indigo-100 bg-indigo-50/50 rounded-xl p-4 text-sm text-gray-700 whitespace-pre-wrap">{summary}</div>}
                        <div ref={endRef} />
                    </div>

                    <div className="p-4 bg-white border-t">
                        <div className="relative">
                            <input value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && onSend(input) && setInput('')} placeholder={apiKey ? "向 DeepSeek 提问..." : "请先配置 Key..."} disabled={isAiThinking} className="w-full pl-4 pr-10 py-3 bg-gray-50 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500" />
                            <button onClick={() => onSend(input) && setInput('')} disabled={!input.trim() || isAiThinking} className="absolute right-2 top-2 p-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300"><LucideIcon name="Send" size={16} /></button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [file, setFile] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [status, setStatus] = useState('idle');
            const [errorMsg, setErrorMsg] = useState(null);
            const [parsedData, setParsedData] = useState([]);
            const [highlightedId, setHighlightedId] = useState(null);
            const [history, setHistory] = useState([]);
            const [isAiThinking, setIsAiThinking] = useState(false);
            const [summary, setSummary] = useState(null);
            const [isSummarizing, setIsSummarizing] = useState(false);
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('deepseek_api_key') || '');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);

            const handleFile = async (f, err) => {
                if (err) return setErrorMsg(err);
                setErrorMsg(null); setFile(f); setStatus('uploading');
                try {
                    await apiService.upload(f, setUploadProgress);
                    setStatus('parsing');
                    const res = await apiService.parse(f);
                    setParsedData(res.data); setStatus('interactive');
                } catch (e) { setErrorMsg('解析失败'); setStatus('idle'); }
            };

            const handleSend = async (q) => {
                if (!q.trim()) return;
                setHistory(prev => [...prev, { role: 'user', content: q }]);
                setIsAiThinking(true);
                try {
                    const res = await apiService.askAI(q, parsedData, apiKey);
                    setHistory(prev => [...prev, { role: 'ai', content: res.answer }]);
                } catch (e) { setHistory(prev => [...prev, { role: 'ai', content: e.message, isError: true }]); }
                setIsAiThinking(false);
            };

            const handleSummary = async () => {
                setIsSummarizing(true);
                try {
                    const res = await apiService.summarize(parsedData, apiKey);
                    setSummary(res.summary);
                    setHistory(prev => [...prev, { role: 'ai', content: '已生成总结' }]);
                } catch (e) { setHistory(prev => [...prev, { role: 'ai', content: e.message, isError: true }]); }
                setIsSummarizing(false);
            };

            return (
                <div className="flex flex-col h-screen bg-white text-gray-800 font-sans overflow-hidden">
                    <Header onOpenSettings={() => setIsSettingsOpen(true)} hasKey={!!apiKey} />
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} apiKey={apiKey} onSave={(k) => { setApiKey(k); localStorage.setItem('deepseek_api_key', k); setHistory([]); setSummary(null); }} />
                    <main className="flex-1 flex overflow-hidden">
                        <UploadZone onFileSelected={handleFile} uploadProgress={uploadProgress} status={status} errorMsg={errorMsg} reset={() => { setFile(null); setStatus('idle'); setParsedData([]); setHistory([]); setSummary(null); }} file={file} />
                        <PreviewZone parsedData={parsedData} status={status} highlightedId={highlightedId} />
                        <ChatZone status={status} onJumpTo={setHighlightedId} history={history} onSend={handleSend} isAiThinking={isAiThinking} summary={summary} onGenerateSummary={handleSummary} isSummarizing={isSummarizing} apiKey={apiKey} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>