<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PM å†œåœºï¼šV11.0 çŸ¥è¯†åº“æ‰©å®¹ç‰ˆ</title>
    <style>
        /* --- 1. åŸºç¡€æ ·å¼ --- */
        :root {
            --c-bg: #2c3e50;
            --c-primary: #4A90E2;
            --c-accent: #9b59b6;
            --c-soil-empty: #E0C38C;
            --c-soil-growing: #90EE90;
            --c-soil-ripe: #FFD700;
            --c-locked: #bdc3c7;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--c-bg); color: #333; display: flex; justify-content: center; min-height: 100vh; }
        
        #game-app { width: 100%; max-width: 600px; background: #f4f6f9; display: flex; flex-direction: column; height: 100vh; position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5); }

        /* --- 2. é¡¶éƒ¨æ  --- */
        .header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; z-index: 10; height: 100px;}
        .user-block { display: flex; align-items: center; gap: 15px; cursor: pointer; padding: 5px; border-radius: 10px; transition: 0.2s; position: relative; }
        .user-block:active { background: #f0f0f0; transform: scale(0.98); }
        
        .red-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: #e74c3c; border-radius: 50%; border: 2px solid white; display: none; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .red-dot.show { display: block; }

        .avatar-container { position: relative; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background: #ecf0f1; display: grid; place-items: center; font-size: 28px; z-index: 1; border: 2px solid white; position: relative; color: #95a5a6; overflow: hidden;}
        
        /* è¾¹æ¡†ç‰¹æ•ˆ */
        .frame-nature { position: absolute; inset: -6px; border-radius: 50%; border: 4px solid #4CAF50; box-shadow: 0 0 10px #81C784; z-index: 2; pointer-events: none; }
        .frame-bunny { position: absolute; inset: -6px; border-radius: 50%; border: 4px solid #FF69B4; box-shadow: 0 0 10px #FFB6C1; z-index: 2; pointer-events: none; }
        .frame-ice { position: absolute; inset: -5px; border-radius: 50%; border: 4px solid #B0E0E6; box-shadow: 0 0 15px #00BFFF; animation: pulse-ice 2s infinite; z-index: 2; pointer-events: none; }
        .frame-cyber { position: absolute; inset: -5px; border-radius: 50%; border: 3px solid #0ff; box-shadow: 0 0 10px #0ff, inset 0 0 5px #0ff; z-index: 2; pointer-events: none; animation: spin 4s linear infinite; }
        @keyframes pulse-ice { 0% {box-shadow: 0 0 5px #00BFFF;} 50% {box-shadow: 0 0 20px #00BFFF;} 100% {box-shadow: 0 0 5px #00BFFF;} }
        @keyframes spin { 0% {filter:hue-rotate(0deg);} 100% {filter:hue-rotate(360deg);} }

        .user-details { display: flex; flex-direction: column; justify-content: center; }
        .feature-link { font-size: 10px; color: #d35400; background: #fff3e0; padding: 2px 6px; border-radius: 4px; margin-top: 4px; font-weight: bold; border: 1px solid #ffe0b2; }

        .stats-col { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
        .res-pill { background: #fff; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 700; border: 1px solid #ddd; min-width: 90px; text-align: center;}

        /* --- 3. å†œç”° --- */
        .farm-area { flex: 1; background: #eef2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .farm-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; width: 100%; max-width: 450px; }
        .land { aspect-ratio: 1; border-radius: 8px; background: var(--c-soil-empty); position: relative; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.1); transition: 0.1s; overflow: hidden; }
        .land:active { transform: scale(0.95); }
        
        .land[data-status="locked"] { background: var(--c-locked); cursor: not-allowed; box-shadow: none; opacity: 0.5; border: 1px dashed #7f8c8d; }
        .land[data-status="buyable"] { background: #f1c40f; cursor: pointer; opacity: 1; border: 2px dashed #d35400; animation: pulse-buy 1s infinite; }
        @keyframes pulse-buy { 50% { transform: scale(0.98); } }
        
        .land[data-status="1"] { background: var(--c-soil-growing); }
        .land[data-status="2"] { background: var(--c-soil-ripe); border: 2px solid #fff; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }

        .buy-land-text { font-size: 10px; font-weight: bold; color: #d35400; text-align: center; line-height: 1.2; }
        
        /* åŠç†Ÿçš®è‚¤æ•ˆæœ */
        .crop-icon { font-size: 26px; transition: 0.3s; position: relative; z-index: 5;}
        .growing-skin { clip-path: inset(0 0 40% 0); transform: translateY(8px) scale(0.8); filter: brightness(0.9) sepia(0.3); opacity: 0.9; }
        /* å‚¬ç†Ÿé—ªç”µæç¤º */
        .speedup-indicator { position: absolute; top: -5px; right: -5px; font-size: 12px; animation: blink 1s infinite; z-index: 10; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .pop-anim { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from {transform: scale(0);} to {transform: scale(1);} }

        /* --- 4. åº•éƒ¨æ  --- */
        .toolbar { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; }
        .tool-btn { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px; cursor: pointer; opacity: 0.5; transition: 0.2s; position: relative; }
        .tool-btn.active { opacity: 1; transform: translateY(-5px); color: var(--c-primary); }
        .tool-btn .emoji { font-size: 28px; margin-bottom: 2px; }
        .badge { position: absolute; top: 0; right: 20%; background: #e74c3c; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; border: 2px solid white; }

        /* --- 5. å¼¹çª—é€šç”¨ --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal.open { display: flex; }
        .panel { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; position: relative;}
        
        .tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #999; font-weight: bold; font-size: 14px;}
        .tab.active { color: var(--c-primary); border-bottom: 3px solid var(--c-primary); }
        .tab-content { display: none; flex-direction: column; gap: 10px; }
        .tab-content.active { display: flex; }

        /* åŠŸèƒ½åˆ—è¡¨å¼¹çª— */
        .feature-list { display: flex; flex-direction: column; gap: 10px; }
        .feature-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fdfdfd; }
        .feature-item.locked { background: #f0f0f0; color: #999; }
        .feature-name { font-weight: bold; font-size: 14px; }
        .feature-desc { font-size: 11px; color: #7f8c8d; margin-top: 2px; }
        .feature-status { font-size: 12px; font-weight: bold; }
        .status-unlocked { color: #27ae60; }
        .status-locked { color: #c0392b; }

        /* è´­ä¹°æ•°é‡ */
        .qty-modal-content { text-align: center; padding: 10px; }
        .qty-slider-val { font-size: 32px; font-weight: bold; color: var(--c-primary); margin: 10px 0; }
        .qty-total-price { font-size: 18px; color: #d35400; margin-bottom: 20px; }
        input[type=range] { width: 100%; margin: 15px 0; }

        /* ä¸ªäººä¸­å¿ƒ */
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px 0; }
        .avatar-opt { font-size: 32px; padding: 10px; background: #f8f9fa; border-radius: 12px; cursor: pointer; text-align: center; border: 2px solid transparent; position: relative; }
        .avatar-opt.selected { background: #e3f2fd; border-color: var(--c-primary); transform: scale(1.1); }
        .avatar-opt.locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); background: #ecf0f1; }
        .avatar-opt.locked::after { content: 'ğŸ”’'; position: absolute; bottom: 2px; right: 2px; font-size: 10px; }

        /* åˆ—è¡¨é¡¹ */
        .shop-item, .frame-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 8px; }
        .frame-item.locked { background: #f9f9f9; opacity: 0.7; filter: grayscale(1); }
        .frame-preview { width: 40px; height: 40px; border-radius: 50%; background: #ddd; position: relative; border: 2px solid white; display: grid; place-items: center;}
        .btn-buy, .btn-use { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; border: none;}
        .btn-buy { background: #f39c12; color: white; }
        .btn-buy:disabled { background: #ccc; }
        .btn-use { background: #eee; color: #666; }
        .btn-use.active { background: var(--c-primary); color: white; cursor: default; }

        /* å‡çº§æŠ¥å‘Š */
        .unlock-section { background: #fcf8e3; padding: 15px; border-radius: 10px; text-align: left; margin: 15px 0; border: 1px solid #faebcc; }
        .unlock-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 13px; color: #8a6d3b; }

        /* æ‚¬æµ®æŒ‰é’® */
        .quiz-btn { position: absolute; top: 115px; right: 15px; background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4); cursor: pointer; z-index: 20; animation: float 3s ease-in-out infinite; }
        .float-actions { position: absolute; bottom: 20px; display: flex; gap: 10px; z-index: 20; }
        .action-btn { border: none; padding: 10px 20px; border-radius: 25px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(0); transition: 0.3s; display: none; }
        .action-btn.show { transform: scale(1); display: block; }
        @keyframes float { 0% {transform: translateY(0);} 50% {transform: translateY(-5px);} 100% {transform: translateY(0);} }

        #toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200; font-weight: bold; width: max-content; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 2px solid #eee; border-radius: 10px; margin: 15px 0; font-family: inherit; resize: none; }
    </style>
</head>
<body>

<div id="game-app">
    <header class="header">
        <div class="user-block" onclick="ui.openProfile()">
            <div class="red-dot" id="profile-red-dot"></div>
            <div class="avatar-container">
                <div class="avatar" id="ui-avatar">ğŸ‘¤</div>
                <div id="ui-frame"></div>
            </div>
            <div class="user-details">
                <div style="font-weight:bold; font-size:16px; color:#2c3e50;">äº§å“ç»ç†</div>
                <div style="display:flex; justify-content:space-between; align-items:center; width: 100px;">
                    <div id="ui-level" style="font-size:13px; color:#7f8c8d; font-weight:bold;">Lv.1</div>
                </div>
                <div class="feature-link" onclick="event.stopPropagation(); ui.openFeatures()">ğŸ“œ å·²è§£é”åŠŸèƒ½</div>
            </div>
        </div>
        <div class="stats-col">
            <div class="res-pill" id="ui-money" style="color:#d35400; background:#fdf2e9; border-color:#f5c6cb;">ğŸ’° 0</div>
            <div class="res-pill" id="ui-exp" style="color:#2980b9; background:#ebf5fb; border-color:#aed6f1;">â­ 0/100</div>
        </div>
    </header>

    <button class="quiz-btn" onclick="quiz.start()">ğŸ§  ç­”é¢˜ (èµšé‡‘å¸)</button>

    <main class="farm-area">
        <div class="farm-grid" id="farm-grid"></div>
        <div class="float-actions">
            <button class="action-btn" id="btn-auto-plant" style="background:#3498db" onclick="game.autoPlant()">âœ¨ ä¸€é”®æ’­ç§</button>
            <button class="action-btn" id="btn-auto-harvest" style="background:#2ecc71" onclick="game.autoHarvest()">âš¡ ä¸€é”®æ”¶å‰²</button>
        </div>
    </main>

    <footer class="toolbar">
        <div class="tool-btn" onclick="ui.openShop()">
            <span class="emoji">ğŸª</span><small>å•†åº—</small>
        </div>
        <div class="tool-btn active" id="tool-seed" onclick="game.selectTool('seed')">
            <span class="emoji">ğŸ’</span><small>æ’­ç§</small>
            <div class="badge" id="ui-seed-count">0</div>
        </div>
        <div class="tool-btn" id="tool-harvest" onclick="game.selectTool('harvest')">
            <span class="emoji">ğŸ§¤</span><small>æ”¶è·</small>
        </div>
        <div class="tool-btn" id="tool-shovel" onclick="game.selectTool('shovel')">
            <span class="emoji">ğŸšœ</span><small>é“²é™¤</small>
        </div>
    </footer>

    <div class="modal" id="modal-shop">
        <div class="panel">
            <div class="tabs">
                <div class="tab active" onclick="ui.switchTab('shop', 'seeds')" id="tab-seeds">ğŸŒ± ç§å­</div>
                <div class="tab" onclick="ui.switchTab('shop', 'skins')" id="tab-skins">ğŸ¨ çš®è‚¤ (Lv.5)</div>
            </div>
            <div class="tab-content active" id="list-seeds"></div>
            <div class="tab-content" id="list-skins">
                <div id="skin-items-container"></div>
            </div>
            <button onclick="ui.closeModals()" style="margin-top:15px; padding:10px; background:#eee; border:none; border-radius:8px;">å…³é—­</button>
        </div>
    </div>

    <div class="modal" id="modal-buy-qty">
        <div class="panel">
            <h3 style="text-align:center; margin:0">é‡‡è´­è¯¦æƒ…</h3>
            <div class="qty-modal-content">
                <div id="buy-item-name" style="font-weight:bold; color:#555;">èƒ¡èåœ</div>
                <input type="range" id="buy-range" min="1" max="50" value="1" oninput="ui.updateBuyCalc()">
                <div class="qty-slider-val">x <span id="buy-qty-val">1</span></div>
                <div class="qty-total-price">æ€»ä»·: <span id="buy-total-cost">10</span> ğŸ’°</div>
                <div style="display:flex; gap:10px;">
                    <button onclick="document.getElementById('modal-buy-qty').classList.remove('open')" style="flex:1; padding:10px; border-radius:8px; border:none;">å–æ¶ˆ</button>
                    <button onclick="ui.confirmBuy()" style="flex:1; padding:10px; background:var(--c-primary); color:white; border-radius:8px; border:none; font-weight:bold;">ç¡®è®¤æ”¯ä»˜</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-profile">
        <div class="panel">
            <h3 style="margin:0 0 15px 0; text-align:center;">ğŸ‘¤ ä¸ªäººå½¢è±¡ä¸­å¿ƒ</h3>
            <div class="tabs">
                <div class="tab active" onclick="ui.switchTab('profile', 'avatar')" id="tab-avatar">ğŸ™‚ å¤´åƒ</div>
                <div class="tab" onclick="ui.switchTab('profile', 'frame')" id="tab-frame">ğŸ–¼ï¸ è¾¹æ¡†</div>
            </div>
            <div class="tab-content active" id="panel-avatar">
                <div id="avatar-list" class="avatar-grid"></div>
            </div>
            <div class="tab-content" id="panel-frame">
                <div id="frame-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
            <button onclick="ui.closeModals()" style="margin-top:15px; padding:10px; background:#eee; border:none; border-radius:8px;">ä¿å­˜å¹¶å…³é—­</button>
        </div>
    </div>

    <div class="modal" id="modal-features">
        <div class="panel">
            <h3 style="text-align:center; margin-bottom:15px">ğŸ“œ å†œåœºåŠŸèƒ½å…¨è§ˆ</h3>
            <div id="feature-list" class="feature-list"></div>
            <button onclick="ui.closeModals()" style="margin-top:15px; padding:10px; background:#eee; border:none; border-radius:8px;">å…³é—­</button>
        </div>
    </div>

    <div class="modal" id="modal-quiz">
        <div class="panel">
            <div style="background:#e1f5fe; color:#0277bd; padding:4px 8px; border-radius:4px; font-size:11px; display:inline-block; margin-bottom:5px;">PM Interview</div>
            <div style="font-weight:bold; color:#2c3e50; margin:10px 0;" id="q-text">Loading...</div>
            <textarea id="q-input" placeholder="ä½œä¸ºé«˜é˜¶ PMï¼Œè¯·ç»™å‡ºè‡³å°‘20å­—çš„ä¸“ä¸šè§è§£..."></textarea>
            <div style="color:#d35400; font-size:12px; margin-bottom:10px;">ğŸ† å¥–åŠ±: <span id="q-reward"></span></div>
            <button onclick="quiz.submit()" style="width:100%; padding:10px; background:var(--c-primary); color:white; border:none; border-radius:8px; font-weight:bold;">æäº¤æ–¹æ¡ˆ</button>
        </div>
    </div>

    <div class="modal" id="modal-levelup">
        <div class="panel" style="text-align:center;">
            <h2 style="color:#f1c40f; margin:0; text-shadow: 1px 1px 0 #e67e22;">ğŸ‰ LEVEL UP!</h2>
            <p>æ™‹å‡è‡³ <span id="lvl-num" style="font-weight:bold; font-size:20px;">Lv.2</span></p>
            <div class="unlock-section">
                <div style="font-weight:bold; margin-bottom:10px; color:#333;">ğŸ“Š æ™‹å‡æŠ¥å‘Š:</div>
                <div id="lvl-unlock-list"></div>
            </div>
            <button onclick="ui.closeModals()" style="width:100%; padding:12px; background:#f39c12; color:white; border:none; border-radius:25px; font-weight:bold;">æ”¶ä¸‹å¥–åŠ±</button>
        </div>
    </div>

    <div class="modal" id="modal-speedup">
        <div class="panel">
            <h3 style="text-align:center">âš¡ é‡‘å¸å‚¬ç†Ÿ</h3>
            <p style="text-align:center">æ˜¯å¦èŠ±è´¹ <span id="speedup-cost" style="color:#d35400; font-weight:bold"></span> é‡‘å¸ç«‹å³æ”¶è·ï¼Ÿ</p>
            <div style="text-align:center; font-size:12px; color:#999; margin-bottom:15px;">(åŒå€ç§å­ä»·æ ¼)</div>
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('modal-speedup').classList.remove('open')" style="flex:1; padding:10px; border-radius:8px; border:none;">å–æ¶ˆ</button>
                <button onclick="game.confirmSpeedUp()" style="flex:1; padding:10px; background:var(--c-primary); color:white; border-radius:8px; border:none; font-weight:bold;">ç«‹å³å‚¬ç†Ÿ</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>
</div>

<script>
    /**
     * --- 1. æ•°æ®é…ç½® (Data) ---
     */
    const GAME_FEATURES = [
        { lvl: 2, name: "åœŸåœ°æ‰©å»º", desc: "æ¯çº§è‡ªåŠ¨è§£é”ä¸€å—æ–°åœŸåœ° (Lv.2-10)" },
        { lvl: 3, name: "é‡‘å¸å‚¬ç†Ÿ", desc: "ä»˜è´¹ç«‹å³æ”¶è·ä»»æ„ä½œç‰© (åŒå€ä»·æ ¼)" },
        { lvl: 3, name: "è‡ªç„¶å¤´åƒæ¡†", desc: "è§£é”è‡ªç„¶ä¸»é¢˜å¤´åƒæ¡†" },
        { lvl: 4, name: "ä¸€é”®æ’­ç§", desc: "è§£æ”¾åŒæ‰‹ï¼Œæ‰¹é‡ç§æ¤" },
        { lvl: 5, name: "çš®è‚¤å•†åº—", desc: "è´­ä¹°ä½œç‰©ä¸ªæ€§åŒ–çš®è‚¤" },
        { lvl: 6, name: "èŒå…”å¤´åƒæ¡†", desc: "è§£é”èŒå…”ä¸»é¢˜å¤´åƒæ¡†" },
        { lvl: 9, name: "å‡›å†¬å¤´åƒæ¡†", desc: "è§£é”å‡›å†¬ä¸»é¢˜å¤´åƒæ¡†" },
        { lvl: 10, name: "é‡‘å¸ä¹°åœ°", desc: "èŠ±è´¹é‡‘å¸è´­ä¹°æ— é™åœŸåœ°" }
    ];

    const FRAMES = [
        { id: 'none',   name: 'æ— è¾¹æ¡†',     class: '',            reqLvl: 1 },
        { id: 'nature', name: 'è‡ªç„¶ä¹‹æ¯',   class: 'frame-nature',reqLvl: 3 },
        { id: 'bunny',  name: 'èŒå…”è€³è¯­',   class: 'frame-bunny', reqLvl: 6 },
        { id: 'ice',    name: 'å‡›å†¬å°†è‡³',   class: 'frame-ice',   reqLvl: 9 },
        { id: 'cyber',  name: 'èµ›åšæœªæ¥',   class: 'frame-cyber', reqLvl: 12 }
    ];

    const LEVELS = {
        1: { req: 100,  gift: 'carrot', count: 5,  qExp: 25, qMoney: 100 },
        2: { req: 250,  gift: 'corn',   count: 4,  qExp: 50, qMoney: 200 },
        3: { req: 500,  gift: 'corn',   count: 8,  qExp: 80, qMoney: 300 }, 
        4: { req: 1000, gift: 'rose',   count: 5,  qExp: 150, qMoney: 500 },
        5: { req: 1800, gift: 'rose',   count: 8,  qExp: 200, qMoney: 800 },
        6: { req: 3000, gift: 'pump',   count: 5,  qExp: 300, qMoney: 1200 },
        7: { req: 5000, gift: 'pump',   count: 10, qExp: 500, qMoney: 2000 },
        8: { req: 8000, gift: 'chip',   count: 3,  qExp: 800, qMoney: 3000 }, 
        9: { req: 12000,gift: 'chip',   count: 5,  qExp: 1000,qMoney: 5000 },
        10:{ req: 20000,gift: 'brain',  count: 2,  qExp: 2000,qMoney: 8000 }
    };

    const CROPS = {
        carrot: { id: 'carrot', name: 'èƒ¡èåœ', cost: 10, exp: 10, time: 3000, reqLvl: 1 },
        corn:   { id: 'corn',   name: 'ç‰ç±³',   cost: 50, exp: 30, time: 6000, reqLvl: 2 },
        rose:   { id: 'rose',   name: 'ç«ç‘°',   cost: 120,exp: 80, time: 10000,reqLvl: 4 },
        pump:   { id: 'pump',   name: 'å—ç“œ',   cost: 300,exp: 200,time: 20000,reqLvl: 6 },
        chip:   { id: 'chip',   name: 'GPUèŠ¯ç‰‡',cost: 1000,exp: 500,time: 40000,reqLvl: 8 },
        brain:  { id: 'brain',  name: 'ç¥ç»ç½‘ç»œ',cost:3000,exp: 1500,time:60000,reqLvl: 10}
    };

    const SKINS = {
        carrot: [{icon:'ğŸ¥•',name:'é»˜è®¤',cost:0}, {icon:'ğŸ¥—',name:'æ²™æ‹‰',cost:200}],
        corn:   [{icon:'ğŸŒ½',name:'é»˜è®¤',cost:0}, {icon:'ğŸ¿',name:'çˆ†ç±³èŠ±',cost:500}, {icon:'ğŸŒ®',name:'ç‰ç±³å·',cost:800}],
        rose:   [{icon:'ğŸŒ¹',name:'é»˜è®¤',cost:0}, {icon:'ğŸ’',name:'èŠ±æŸ',cost:1000}, {icon:'ğŸ¥€',name:'é»‘ç«ç‘°',cost:1500}],
        pump:   [{icon:'ğŸƒ',name:'é»˜è®¤',cost:0}, {icon:'ğŸ¥§',name:'å—ç“œæ´¾',cost:2000}, {icon:'ğŸ‘»',name:'å¹½çµ',cost:3000}],
        chip:   [{icon:'ğŸ’¾',name:'é»˜è®¤',cost:0}, {icon:'ğŸ’½',name:'é‡‘æ‰‹æŒ‡',cost:5000}, {icon:'ğŸ’',name:'é‡å­æ ¸',cost:8000}],
        brain:  [{icon:'ğŸ§ ',name:'é»˜è®¤',cost:0}, {icon:'ğŸ¤–',name:'å¤©ç½‘',cost:10000},{icon:'ğŸŒŒ',name:'å®‡å®™è„‘',cost:20000}]
    };

    // 50+ é¢˜åº“ (ç¤ºä¾‹éƒ¨åˆ†)
    const RAW_QUESTIONS = [
        "è¯·ç®€è¿° RAG æŠ€æœ¯åœ¨è§£å†³å¤§æ¨¡å‹å¹»è§‰ä¸­çš„ä½œç”¨ã€‚",
        "MoE æ¶æ„ç›¸æ¯” Dense æ¨¡å‹åœ¨æ¨ç†æˆæœ¬ä¸Šçš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ",
        "å¦‚ä½•è®¾è®¡ä¸€å¥—æœ‰æ•ˆçš„ AI Agent è®°å¿†æ£€ç´¢æœºåˆ¶ï¼Ÿ",
        "åœ¨ ToB åœºæ™¯ä¸‹ï¼Œå¦‚ä½•è¯„ä¼°ç§æœ‰åŒ–æ¨¡å‹çš„ä¸šåŠ¡ ROIï¼Ÿ",
        "é’ˆå¯¹å¤šæ¨¡æ€æ¨¡å‹ï¼Œå¦‚ä½•ä¼˜åŒ–å›¾æ–‡è¯­ä¹‰å¯¹é½çš„æ•ˆæœï¼Ÿ",
        "è§£é‡Š RLHF çš„æ ¸å¿ƒæ­¥éª¤åŠå…¶åœ¨æ¨¡å‹å¯¹é½ä¸­çš„ä½œç”¨ã€‚",
        "Transformer æ¶æ„ä¸­ Self-Attention æœºåˆ¶è§£å†³äº† RNN çš„ä»€ä¹ˆç—›ç‚¹ï¼Ÿ",
        "åœ¨å¤§æ¨¡å‹å¾®è°ƒä¸­ï¼ŒLoRA ç›¸æ¯”å…¨é‡å¾®è°ƒæœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿ",
        "å¦‚ä½•åˆ©ç”¨ Chain-of-Thought (CoT) æå‡æ¨¡å‹çš„æ¨ç†èƒ½åŠ›ï¼Ÿ",
        "å‘é‡æ•°æ®åº“ (Vector DB) åœ¨å¤§æ¨¡å‹åº”ç”¨ä¸­çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ",
        "å¦‚ä½•é€šè¿‡ç”¨æˆ·è°ƒç ”ç¡®å®š AI äº§å“çš„ MVP åŠŸèƒ½è¾¹ç•Œï¼Ÿ",
        "åœ¨ä¸ç®—æ³•å·¥ç¨‹å¸ˆæ²Ÿé€šæ—¶ï¼Œå¦‚ä½•å‡†ç¡®æè¿°ä¸šåŠ¡éœ€æ±‚çš„æ•°å­¦æŒ‡æ ‡ï¼Ÿ",
        "å½“æ¨¡å‹è¾“å‡ºä¸ç¨³å®šæ—¶ï¼Œäº§å“ä¾§æœ‰å“ªäº›å…œåº•ç­–ç•¥ï¼Ÿ",
        "å¦‚ä½•è®¾è®¡ Prompt æ¨¡æ¿ä»¥æé«˜æ¨¡å‹è¾“å‡ºçš„ä¸€è‡´æ€§ï¼Ÿ",
        "AI äº§å“åœ¨å†·å¯åŠ¨é˜¶æ®µï¼Œå¦‚ä½•è·å–é«˜è´¨é‡çš„ç§å­æ•°æ®ï¼Ÿ",
        "è¯·åˆ—ä¸¾ä¸‰ç§å¸¸è§çš„ Prompt æ”»å‡»æ–¹å¼åŠå…¶é˜²å¾¡ç­–ç•¥ã€‚",
        "ä»€ä¹ˆæ˜¯ Context Windowï¼Ÿå®ƒå¦‚ä½•å½±å“é•¿æ–‡æ¡£å¤„ç†ä½“éªŒï¼Ÿ",
        "å¦‚ä½•è¡¡é‡ç”Ÿæˆå¼ AI äº§å“çš„ç”¨æˆ·æ»¡æ„åº¦ (CSAT)ï¼Ÿ",
        "åœ¨ AIGC ç‰ˆæƒé—®é¢˜ä¸Šï¼Œäº§å“ç»ç†éœ€è¦æ³¨æ„å“ªäº›åˆè§„é£é™©ï¼Ÿ",
        "Agent è§„åˆ’èƒ½åŠ› (Planning) çš„å¸¸è§å®ç°æ–¹å¼æœ‰å“ªäº›ï¼Ÿ",
        "å¦‚ä½•å¹³è¡¡æ¨¡å‹å“åº”é€Ÿåº¦ (Latency) ä¸ç”Ÿæˆè´¨é‡ï¼Ÿ",
        "ä»€ä¹ˆæ˜¯ Temperature å‚æ•°ï¼Ÿå®ƒå¦‚ä½•å½±å“æ¨¡å‹çš„åˆ›é€ æ€§ï¼Ÿ",
        "è§£é‡Š Embedding çš„æ¦‚å¿µåŠå…¶åœ¨è¯­ä¹‰æœç´¢ä¸­çš„åº”ç”¨ã€‚",
        "Knowledge Graph (çŸ¥è¯†å›¾è°±) å¦‚ä½•å¢å¼º LLM çš„äº‹å®å‡†ç¡®æ€§ï¼Ÿ",
        "åœ¨ Copilot ç±»äº§å“ä¸­ï¼Œå¦‚ä½•è®¾è®¡äººæœºäº¤äº’çš„'ä»‹å…¥åº¦'ï¼Ÿ",
        "å¦‚ä½•é€šè¿‡ AB æµ‹è¯•éªŒè¯ä¸åŒ Prompt çš„æ•ˆæœï¼Ÿ",
        "ä»€ä¹ˆæ˜¯ Zero-shot, One-shot, Few-shot Learningï¼Ÿ",
        "åœ¨æ¨¡å‹è’¸é¦ (Distillation) ä¸­ï¼ŒTeacher å’Œ Student æ¨¡å‹çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ",
        "å¦‚ä½•è¯„ä¼°ä¸€ä¸ª AI äº§å“çš„æŠ€æœ¯æŠ¤åŸæ²³ï¼Ÿ",
        "è§£é‡Š Token çš„æ¦‚å¿µï¼Œä»¥åŠå®ƒä¸å•è¯æ•°é‡çš„å¤§è‡´å…³ç³»ã€‚",
        "ä»€ä¹ˆæ˜¯ Hallucination (å¹»è§‰)ï¼Ÿåœ¨åŒ»ç–—/é‡‘èé¢†åŸŸå¦‚ä½•é£æ§ï¼Ÿ",
        "å¦‚ä½•è®¾è®¡ä¸€ä¸ªåŸºäº LLM çš„è‡ªåŠ¨åŒ–å®¢æœç³»ç»Ÿï¼Ÿ",
        "åœ¨ AI äº§å“è¿­ä»£ä¸­ï¼ŒBad Case çš„æ”¶é›†ä¸æ¸…æ´—æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ",
        "ä»€ä¹ˆæ˜¯ Multi-agent Systemï¼Ÿå®ƒé€‚ç”¨äºå“ªäº›å¤æ‚åœºæ™¯ï¼Ÿ",
        "å¦‚ä½•åˆ©ç”¨ AI æå‡ B ç«¯ SaaS äº§å“çš„æ“ä½œæ•ˆç‡ï¼Ÿ",
        "è§£é‡Š Diffusion Model åœ¨å›¾åƒç”Ÿæˆä¸­çš„åŸºæœ¬åŸç†ã€‚",
        "åœ¨è¯­éŸ³åˆæˆ (TTS) äº§å“ä¸­ï¼Œå¦‚ä½•ä¼˜åŒ–æƒ…æ„Ÿè¡¨è¾¾çš„è‡ªç„¶åº¦ï¼Ÿ",
        "ä»€ä¹ˆæ˜¯ Scaling Lawï¼Ÿå®ƒå¯¹æ¨¡å‹ç ”å‘æŠ•å…¥æœ‰ä½•æŒ‡å¯¼æ„ä¹‰ï¼Ÿ",
        "å¦‚ä½•è®¾è®¡ AI ç”Ÿæˆå†…å®¹çš„æ°´å°æœºåˆ¶ï¼Ÿ",
        "åœ¨ä»£ç ç”ŸæˆåŠ©æ‰‹äº§å“ä¸­ï¼Œå¦‚ä½•ä¿éšœç”Ÿæˆçš„ä»£ç å®‰å…¨æ€§ï¼Ÿ",
        "ä»€ä¹ˆæ˜¯ In-context Learningï¼Ÿ",
        "å¦‚ä½•åˆ©ç”¨ Feedback Loop æŒç»­ä¼˜åŒ–æ¨¡å‹æ•ˆæœï¼Ÿ",
        "åœ¨æ¨èç³»ç»Ÿä¸­ï¼Œå¤§æ¨¡å‹å¯ä»¥æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ",
        "è§£é‡Š PPO (Proximal Policy Optimization) ç®—æ³•çš„ä½œç”¨ã€‚",
        "å¦‚ä½•è¯„ä¼° RAG ç³»ç»Ÿçš„æ£€ç´¢å¬å›ç‡ä¸ç”Ÿæˆå‡†ç¡®ç‡ï¼Ÿ",
        "ä»€ä¹ˆæ˜¯ Quantization (é‡åŒ–)ï¼Ÿå®ƒå¦‚ä½•å¸®åŠ©æ¨¡å‹åœ¨ç«¯ä¾§éƒ¨ç½²ï¼Ÿ",
        "å¦‚ä½•è®¾è®¡ AI äº§å“çš„éšç§ä¿æŠ¤æœºåˆ¶ (å¦‚ PII è¿‡æ»¤)ï¼Ÿ",
        "åœ¨è™šæ‹Ÿäººäº§å“ä¸­ï¼Œå¦‚ä½•å®ç°å®æ—¶çš„è¯­éŸ³é©±åŠ¨å£å‹ï¼Ÿ",
        "ä»€ä¹ˆæ˜¯ AGIï¼Ÿç›®å‰çš„å¤§æ¨¡å‹è·ç¦» AGI è¿˜æœ‰å¤šè¿œï¼Ÿ",
        "å¦‚ä½•é€šè¿‡æ•°æ®é£è½® (Data Flywheel) å»ºç«‹äº§å“ä¼˜åŠ¿ï¼Ÿ"
    ];

    const AVATARS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·"];

    /**
     * --- 2. çŠ¶æ€ç®¡ç† ---
     */
    const state = {
        player: { 
            money: 0, exp: 0, level: 1, 
            avatar: 'ğŸ‘¤', frame: 'none', unlockedFrames: ['none'], 
            unlockedAvatars: [], hasNewItem: false 
        },
        inventory: { carrot: 5, corn:0, rose:0, pump:0, chip:0, brain:0 },
        skinOwned: { carrot:[0], corn:[0], rose:[0], pump:[0], chip:[0], brain:[0] },
        skinEquipped: { carrot:0, corn:0, rose:0, pump:0, chip:0, brain:0 },
        lands: Array(18).fill(null).map((_, i) => ({ id: i, status: i<5 ? 0 : 'locked', crop: null, plantTime: 0 })),
        tool: 'seed', selectedSeed: 'carrot',
        
        // ä¸´æ—¶æ•°æ®
        buyTargetId: null, buyTargetCost: 0, buyQty: 1,
        speedUpTargetId: null, speedUpCost: 0,
        quizPool: [] // æ´—ç‰Œåçš„é¢˜åº“
    };

    /**
     * --- 3. æ ¸å¿ƒé€»è¾‘ ---
     */
    const game = {
        init() {
            game.shuffleQuiz(); // åˆå§‹åŒ–æ´—ç‰Œ
            game.updateLandLocks(); 
            ui.renderGrid(); ui.updateHeader();
            game.checkLevelUp();
            setInterval(game.loop, 200);
        },
        
        // æ´—ç‰Œç®—æ³•
        shuffleQuiz() {
            const pool = [...RAW_QUESTIONS];
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            state.quizPool = pool;
        },

        loop() {
            const now = Date.now();
            let dirty=false; let ripe=0;
            state.lands.forEach(l => {
                if(l.status===1 && now-l.plantTime >= CROPS[l.crop].time) { l.status=2; dirty=true; }
                if(l.status===2) ripe++;
            });
            if(dirty) ui.renderGrid();
            document.getElementById('btn-auto-harvest').classList.toggle('show', ripe>0);
            document.getElementById('btn-auto-plant').classList.toggle('show', state.player.level>=4);
        },
        
        updateLandLocks() {
            state.lands.forEach(l => {
                const unlockCount = 5 + Math.max(0, state.player.level - 1);
                if (l.id < unlockCount) {
                    if (l.status === 'locked' || l.status === 'buyable') l.status = 0;
                } else {
                    if (state.player.level >= 10 && l.status === 'locked') l.status = 'buyable';
                }
            });
        },

        handleClick(l) {
            if (l.status === 'buyable') {
                if (state.player.money >= 5000 && confirm("èŠ±è´¹ 5000 é‡‘å¸è´­ä¹°è¿™å—åœŸåœ°ï¼Ÿ")) {
                    state.player.money -= 5000;
                    l.status = 0;
                    ui.updateHeader(); ui.renderGrid(); ui.toast("æ‰©å»ºæˆåŠŸï¼");
                } else if(state.player.money < 5000) ui.toast("é‡‘å¸ä¸è¶³ (éœ€5000)");
                return;
            }
            if (l.status === 'locked') return ui.toast("ç­‰çº§ä¸è¶³ï¼Œæ— æ³•è§£é”");

            if (state.tool === 'seed') game.plant(l);
            else if (state.tool === 'harvest') game.harvest(l);
            else if (state.tool === 'shovel') { 
                if(l.status===1 || l.status===2) { l.status=0; l.crop=null; ui.renderGrid(); }
            }
            else if (l.status === 1) game.trySpeedUp(l);
        },

        plant(land) {
            if(land.status!==0) return;
            const seed = state.selectedSeed;
            if(state.inventory[seed]<=0) {
                if(state.player.money===0 && seed==='carrot') return ui.toast('æ²¡é’±ä¹°ç§å­ï¼Ÿå¿«å»ç­”é¢˜ï¼');
                return ui.toast('åº“å­˜ä¸è¶³ï¼Œè¯·å»å•†åº—');
            }
            if(state.player.level < CROPS[seed].reqLvl) return ui.toast('ç­‰çº§ä¸è¶³');
            state.inventory[seed]--;
            land.status=1; land.crop=seed; land.plantTime=Date.now();
            ui.updateHeader(); ui.renderGrid();
        },

        harvest(land) {
            if(land.status!==2) return;
            const c = CROPS[land.crop];
            game.addExp(c.exp);
            land.status=0; land.crop=null;
            ui.updateHeader(); ui.renderGrid();
            ui.toast(`+${c.exp} Exp`);
        },

        trySpeedUp(land) {
            // Lv.3 å…¨å±€è§£é”å‚¬ç†Ÿ
            if (state.player.level < 3) {
                return ui.toast("Lv.3 è§£é”é‡‘å¸å‚¬ç†ŸåŠŸèƒ½");
            }
            const c = CROPS[land.crop];
            state.speedUpTargetId = land.id;
            state.speedUpCost = c.cost * 2;
            document.getElementById('speedup-cost').innerText = state.speedUpCost;
            document.getElementById('modal-speedup').classList.add('open');
        },
        confirmSpeedUp() {
            if (state.player.money >= state.speedUpCost) {
                state.player.money -= state.speedUpCost;
                const l = state.lands[state.speedUpTargetId];
                l.status = 2;
                ui.closeModals();
                ui.updateHeader(); ui.renderGrid(); ui.toast("âš¡ å‚¬ç†ŸæˆåŠŸï¼");
            } else {
                ui.toast("é‡‘å¸ä¸è¶³");
            }
        },

        addExp(v) {
            state.player.exp += v;
            game.checkLevelUp();
            ui.updateHeader();
        },

        checkLevelUp() {
            const req = LEVELS[state.player.level].req;
            if(state.player.exp >= req) {
                state.player.level++;
                state.player.exp -= req;
                game.updateLandLocks();

                const cfg = LEVELS[state.player.level];
                const unlocks = [];

                // åœŸåœ°
                if(state.player.level <= 10) unlocks.push("ğŸšœ åœŸåœ°æ‰©å»º: +1 å—");
                if(state.player.level === 10) unlocks.push("ğŸ’° å¼€å¯é‡‘å¸ä¹°åœ°åŠŸèƒ½");

                // èµ å“
                if(cfg && cfg.gift) {
                    state.inventory[cfg.gift] = (state.inventory[cfg.gift]||0) + cfg.count;
                    unlocks.push(`ğŸ èµ é€: ${CROPS[cfg.gift].name} x${cfg.count}`);
                }

                // å¤´åƒ
                if(state.player.level % 2 === 0) {
                    const avaIdx = (state.player.level / 2) - 1;
                    if (AVATARS[avaIdx]) {
                        state.player.unlockedAvatars.push(AVATARS[avaIdx]);
                        state.player.hasNewItem = true;
                        unlocks.push(`ğŸ¦ æ–°å¤´åƒ: [${AVATARS[avaIdx]}]`);
                    }
                }

                // è¾¹æ¡†
                const newFrame = FRAMES.find(f => f.reqLvl === state.player.level);
                if(newFrame) {
                    state.player.unlockedFrames.push(newFrame.id);
                    state.player.hasNewItem = true;
                    unlocks.push(`ğŸ–¼ï¸ æ–°è¾¹æ¡†: [${newFrame.name}]`);
                }

                // åŠŸèƒ½
                if(state.player.level === 3) unlocks.push("âš¡ åŠŸèƒ½è§£é”: é‡‘å¸å‚¬ç†Ÿ");
                if(state.player.level === 4) unlocks.push("âœ¨ åŠŸèƒ½è§£é”: ä¸€é”®æ’­ç§");
                if(state.player.level === 5) unlocks.push("ğŸ¨ åŠŸèƒ½è§£é”: çš®è‚¤å•†åº—");

                document.getElementById('lvl-num').innerText = `Lv.${state.player.level}`;
                const list = document.getElementById('lvl-unlock-list');
                list.innerHTML = '';
                unlocks.forEach(txt => {
                    const d = document.createElement('div');
                    d.className = 'unlock-item'; d.innerHTML = `âœ… ${txt}`;
                    list.appendChild(d);
                });
                document.getElementById('modal-levelup').classList.add('open');
                ui.updateHeader();
            }
        },
        
        autoPlant() {
            const s = state.selectedSeed; let c = state.inventory[s];
            if(c<=0) return ui.toast('åº“å­˜ä¸è¶³');
            state.lands.forEach(l=>{ if(l.status===0 && c>0){ game.plant(l); c=state.inventory[s]; }});
        },
        autoHarvest() { state.lands.forEach(l=>{ if(l.status===2) game.harvest(l); }) },
        selectTool(t) {
            state.tool = t;
            document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('tool-'+t).classList.add('active');
        }
    };

    /**
     * --- 4. é¢˜åº“é€»è¾‘ (æŠ½é¢˜) ---
     */
    const quiz = {
        start() {
            if (state.quizPool.length === 0) {
                alert("ğŸ‰ æ­å–œï¼ä½ å·²é€šå…³æ‰€æœ‰è€ƒæ ¸é¢˜ç›®ï¼é¢˜åº“å°†é‡ç½®ã€‚");
                game.shuffleQuiz();
            }
            // å–å‡ºæœ€åä¸€ä¸ªå¹¶åˆ é™¤ (pop)
            const q = state.quizPool.pop();
            
            const cfg = LEVELS[state.player.level] || {qExp:2000, qMoney:8000};
            document.getElementById('q-text').innerText = q;
            document.getElementById('q-reward').innerText = `${cfg.qMoney}ğŸ’° + ${cfg.qExp}â­`;
            document.getElementById('q-input').value = '';
            document.getElementById('modal-quiz').classList.add('open');
        },
        submit() {
            const v = document.getElementById('q-input').value.trim();
            if(v.length < 10) return alert("å›ç­”å¤ªç®€ç•¥ (>10å­—)"); // ç¨å¾®é™ä½é—¨æ§›æ–¹ä¾¿æµ‹è¯•
            const cfg = LEVELS[state.player.level] || {qExp:2000, qMoney:8000};
            state.player.money += cfg.qMoney;
            game.addExp(cfg.qExp);
            ui.closeModals();
            ui.toast(`å›ç­”ç²¾å½©ï¼+${cfg.qMoney}ğŸ’°`);
        }
    };

    /**
     * --- 5. UIé€»è¾‘ ---
     */
    const ui = {
        renderGrid() {
            const el = document.getElementById('farm-grid'); el.innerHTML='';
            state.lands.forEach(l => {
                const d = document.createElement('div');
                d.className = 'land'; d.dataset.status = l.status;
                d.onclick = () => game.handleClick(l);

                if (l.status === 'buyable') {
                    d.innerHTML = `<div class="buy-land-text">åœŸåœ°å‡ºå”®<br>5000ğŸ’°</div><button class="btn-buy" style="font-size:10px;padding:2px 5px;margin-top:2px;">è´­ä¹°</button>`;
                } 
                else if (l.status === 'locked') d.innerHTML = `<div style="font-size:16px;opacity:0.5">ğŸ”’</div>`;
                else if (l.status === 1) {
                    const icon = SKINS[l.crop][state.skinEquipped[l.crop]].icon;
                    // Lv3 å¯å‚¬ç†Ÿ
                    const canSpeed = state.player.level >= 3;
                    const speedHtml = canSpeed ? `<div class="speedup-indicator">âš¡</div>` : '';
                    d.innerHTML = `<div class="crop-icon pop-anim growing-skin">${icon}</div>${speedHtml}`;
                }
                else if (l.status === 2) {
                    const icon = SKINS[l.crop][state.skinEquipped[l.crop]].icon;
                    d.innerHTML = `<div class="crop-icon pop-anim">${icon}</div>`;
                }
                el.appendChild(d);
            });
        },
        updateHeader() {
            document.getElementById('ui-money').innerText=`ğŸ’° ${state.player.money}`;
            const max = LEVELS[state.player.level] ? LEVELS[state.player.level].req : 'Max';
            document.getElementById('ui-exp').innerText=`â­ ${state.player.exp}/${max}`;
            document.getElementById('ui-level').innerText=`Lv.${state.player.level}`;
            document.getElementById('ui-avatar').innerText=state.player.avatar;
            document.getElementById('ui-seed-count').innerText=state.inventory[state.selectedSeed]||0;
            
            const f = FRAMES.find(fr=>fr.id===state.player.frame);
            document.getElementById('ui-frame').className = f ? f.class : '';
            
            const dot = document.getElementById('profile-red-dot');
            if(state.player.hasNewItem) dot.classList.add('show');
            else dot.classList.remove('show');
        },

        // å•†åº—
        openShop() { ui.switchTab('shop', 'seeds'); document.getElementById('modal-shop').classList.add('open'); },
        initBuy(id, singleCost, name) {
            state.buyTargetId = id; state.buyTargetCost = singleCost; state.buyQty = 1;
            document.getElementById('buy-item-name').innerText = name;
            document.getElementById('buy-range').value = 1;
            ui.updateBuyCalc();
            document.getElementById('modal-buy-qty').classList.add('open');
        },
        updateBuyCalc() {
            const q = document.getElementById('buy-range').value;
            state.buyQty = parseInt(q);
            document.getElementById('buy-qty-val').innerText = q;
            document.getElementById('buy-total-cost').innerText = state.buyTargetCost * q;
        },
        confirmBuy() {
            const total = state.buyTargetCost * state.buyQty;
            if (state.player.money >= total) {
                state.player.money -= total;
                state.inventory[state.buyTargetId] += state.buyQty;
                state.selectedSeed = state.buyTargetId; game.selectTool('seed');
                ui.closeModals(); ui.updateHeader(); ui.toast(`è´­ä¹°æˆåŠŸ`);
            } else ui.toast("é‡‘å¸ä¸è¶³");
        },

        // çš®è‚¤
        buySkin(cid, idx, cost) {
            if(state.player.money >= cost) {
                state.player.money -= cost;
                state.skinOwned[cid].push(idx);
                ui.equipSkin(cid, idx);
                ui.updateHeader(); ui.toast('çš®è‚¤è·å¾—ï¼');
            } else ui.toast('é‡‘å¸ä¸è¶³');
        },
        equipSkin(cid, idx) { state.skinEquipped[cid]=idx; ui.switchTab('shop', 'skins'); ui.renderGrid(); },

        // ä¸ªäººä¸­å¿ƒ
        openProfile() {
            state.player.hasNewItem = false; ui.updateHeader();
            ui.renderAvatars(); ui.renderFrames();
            ui.switchTab('profile', 'avatar');
            document.getElementById('modal-profile').classList.add('open');
        },
        renderAvatars() {
            const el=document.getElementById('avatar-list'); el.innerHTML='';
            const defDiv=document.createElement('div');
            defDiv.className=`avatar-opt ${state.player.avatar==='ğŸ‘¤'?'selected':''}`;
            defDiv.innerText='ğŸ‘¤';
            defDiv.onclick=()=>{state.player.avatar='ğŸ‘¤';ui.renderAvatars();ui.updateHeader();};
            el.appendChild(defDiv);

            AVATARS.forEach(a=>{
                const unlocked = state.player.unlockedAvatars.includes(a);
                const d=document.createElement('div'); 
                d.className=`avatar-opt ${!unlocked?'locked':''} ${state.player.avatar===a?'selected':''}`;
                d.innerText=a; 
                if(unlocked) d.onclick=()=>{ state.player.avatar=a; ui.renderAvatars(); ui.updateHeader(); };
                el.appendChild(d);
            });
        },
        renderFrames() {
            const el=document.getElementById('frame-list'); el.innerHTML='';
            FRAMES.forEach(f=>{
                const unlock = state.player.unlockedFrames.includes(f.id);
                const equip = state.player.frame===f.id;
                const d=document.createElement('div'); d.className=`frame-item ${!unlock?'locked':''}`;
                let btn='';
                if(equip) btn=`<button class="btn-use active">ä½¿ç”¨ä¸­</button>`;
                else if(unlock) btn=`<button class="btn-use" onclick="ui.useFrame('${f.id}')">ä½©æˆ´</button>`;
                else btn=`<span style="font-size:12px;color:#e74c3c">Lv.${f.reqLvl} è§£é”</span>`;
                d.innerHTML=`<div style="display:flex;align-items:center"><div class="frame-preview ${f.class}">${state.player.avatar}</div><div style="margin-left:10px;font-weight:bold">${f.name}</div></div>${btn}`;
                el.appendChild(d);
            });
        },
        useFrame(fid) { state.player.frame=fid; ui.renderFrames(); ui.updateHeader(); },

        // åŠŸèƒ½å…¨è§ˆ
        openFeatures() {
            const list = document.getElementById('feature-list'); list.innerHTML='';
            GAME_FEATURES.forEach(f => {
                const unlocked = state.player.level >= f.lvl;
                const d = document.createElement('div');
                d.className = `feature-item ${!unlocked?'locked':''}`;
                const status = unlocked ? '<span class="status-unlocked">âœ… å·²è§£é”</span>' : `<span class="status-locked">ğŸ”’ Lv.${f.lvl}</span>`;
                d.innerHTML = `
                    <div>
                        <div class="feature-name">${f.name}</div>
                        <div class="feature-desc">${f.desc}</div>
                    </div>
                    <div class="feature-status">${status}</div>
                `;
                list.appendChild(d);
            });
            document.getElementById('modal-features').classList.add('open');
        },

        switchTab(ctx, tab) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            if(ctx==='shop') {
                document.getElementById(tab==='seeds'?'list-seeds':'list-skins').classList.add('active');
                if(tab==='seeds') ui.renderSeeds(); else ui.renderSkins();
            } else {
                document.getElementById(`panel-${tab}`).classList.add('active');
            }
        },
        renderSeeds() {
            const list = document.getElementById('list-seeds'); list.innerHTML='';
            Object.values(CROPS).forEach(c => {
                const locked = state.player.level < c.reqLvl;
                const div = document.createElement('div'); div.className='shop-item';
                div.style.opacity = locked ? 0.6 : 1;
                div.innerHTML = `
                    <div><span style="font-size:20px">${SKINS[c.id][0].icon}</span> <b>${c.name}</b> <small>Lv.${c.reqLvl}</small><br>
                    <small style="color:#666">å•ä»·:${c.cost}</small></div>
                    <button class="btn-buy" ${locked?'disabled':''} onclick="ui.initBuy('${c.id}', ${c.cost}, '${c.name}')">è´­ä¹°</button>
                `;
                list.appendChild(div);
            });
        },
        renderSkins() {
            const con = document.getElementById('skin-items-container'); con.innerHTML='';
            if(state.player.level<5) return con.innerHTML='<div style="text-align:center;padding:20px;color:#999">Lv.5 è§£é”çš®è‚¤å•†åº—</div>';
            Object.keys(SKINS).forEach(cid => {
                if(state.player.level < CROPS[cid].reqLvl) return;
                const title=document.createElement('div'); title.innerHTML=`<b>${CROPS[cid].name}ç³»åˆ—</b>`; title.style.marginTop='10px';
                con.appendChild(title);
                SKINS[cid].forEach((sk, idx) => {
                    if(idx===0 && sk.cost===0) return;
                    const owned = state.skinOwned[cid].includes(idx);
                    const equipped = state.skinEquipped[cid]===idx;
                    const div=document.createElement('div'); div.className='shop-item';
                    let btn = '';
                    if(equipped) btn=`<span style="color:green;font-size:12px;font-weight:bold">å·²è£…å¤‡</span>`;
                    else if(owned) btn=`<button class="btn-buy btn-equip" onclick="ui.equipSkin('${cid}',${idx})">è£…å¤‡</button>`;
                    else btn=`<button class="btn-buy" onclick="ui.buySkin('${cid}',${idx},${sk.cost})">${sk.cost}ğŸ’°</button>`;
                    div.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">${sk.icon}</span><div>${sk.name}</div></div>${btn}`;
                    con.appendChild(div);
                });
            });
        },
        
        closeModals() { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('open')); },
        toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2000); }
    };

    game.init();
</script>
</body>
</html>